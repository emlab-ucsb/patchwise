<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="patchwise">
<title>Using patchwise with locked-in and locked-out areas • patchwise</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Using patchwise with locked-in and locked-out areas">
<meta property="og:description" content="patchwise">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">patchwise</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/locked_in_out.html">Using patchwise with locked-in and locked-out areas</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Using patchwise with locked-in and locked-out areas</h1>
            
      
      
      <div class="d-none name"><code>locked_in_out.Rmd</code></div>
    </div>

    
    
<p>Prioritizations can be run using “locked-in” areas (areas that are
already represented by existing protected areas) and “locked-out” areas
(areas that are not available for protection). <code>patchwise</code>
has the capability to include these areas while also creating the
patches that should be protected as a single feature. For more
information on locked-in and locked-out areas, refer to the <a href="https://prioritizr.net/" class="external-link"><code>prioritizr</code>
documentation</a>.</p>
<p>A couple of things to note when using locked-in or locked-out areas
with <code>patchwise</code>:</p>
<ol style="list-style-type: decimal">
<li>If there are several areas you wish to lock-in, combine them into a
single layer. The same goes for locked-out layers.</li>
<li>When using <code>patchwise</code> you do not need to specify
locked-in or locked-out constraints via the <code>prioritizr</code>
<code>problem()</code> function. <code>patchwise</code> creates the
locked-in and locked-out constraints within the
<code><a href="../reference/features_targets.html">features_targets()</a></code> function so that the
<code>problem()</code> finds a solution with 100% of the units in the
locked-in area and 0% of the units in the locked-out area.</li>
</ol>
<p>A quick note about <code>prioritizr</code> - sometimes there are
several cells that are equally worthy of protection. In this case, there
may be some discrepancy in the specific areas that are selected for
protection depending on the input format of the data
(<code>raster</code> vs <code>sf</code>). You’ll notice that this is the
case in our examples here. To get more consistent results, larger
protective targets and/or more features should be added to the
model.</p>
<p>Here are some quick links to hop to different sections that you might
find relevant:</p>
<ul>
<li><a href="#implement-locked-in-areas-using-a-raster-input">Implement
locked-in areas using a <code>raster</code> input</a></li>
<li><a href="#implement-locked-out-areas-using-a-raster-input">Implement
locked-out areas using a <code>raster</code> input</a></li>
<li><a href="#implement-locked-in-and-locked-out-areas-using-a-raster-input">Implement
locked-in and locked-out areas using a <code>raster</code>
input</a></li>
<li><a href="#implement-locked-in-areas-using-an-sf-input">Implement
locked-in areas using an <code>sf</code> input</a></li>
<li><a href="#implement-locked-out-areas-using-an-sf-input">Implement
locked-out areas using an <code>sf</code> input</a></li>
<li><a href="#implement-locked-in-and-locked-out-areas-using-an-sf-input">Implement
locked-in and locked-out areas using an <code>sf</code> input</a></li>
</ul>
<div class="section level2">
<h2 id="implement-locked-in-areas-using-a-raster-input">Implement locked-in areas using a <code>raster</code> input<a class="anchor" aria-label="anchor" href="#implement-locked-in-areas-using-a-raster-input"></a>
</h2>
<p>To generate our data for this example, we will use data from Bermuda
generated via <code>oceandatr</code>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load libraries</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://emlab-ucsb.github.io/patchwise/">patchwise</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Choose area of interest (Bermuda EEZ)</span></span>
<span><span class="va">area</span> <span class="op">&lt;-</span> <span class="fu">oceandatr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/oceandatr/man/get_area.html" class="external-link">get_area</a></span><span class="op">(</span>area_name <span class="op">=</span> <span class="st">"Bermuda"</span>,  mregions_column <span class="op">=</span> <span class="st">"territory1"</span><span class="op">)</span></span>
<span><span class="va">projection</span> <span class="op">&lt;-</span> <span class="st">'+proj=laea +lon_0=-64.8108333 +lat_0=32.3571917 +datum=WGS84 +units=m +no_defs'</span></span>
<span></span>
<span><span class="co"># Create a planning grid</span></span>
<span><span class="va">planning_rast</span> <span class="op">&lt;-</span> <span class="fu">spatialgridr</span><span class="fu">::</span><span class="fu"><a href="https://emlab-ucsb.github.io/spatialgridr/reference/get_grid.html" class="external-link">get_grid</a></span><span class="op">(</span><span class="va">area</span>, projection <span class="op">=</span> <span class="va">projection</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Grab all relevant data</span></span>
<span><span class="va">features_rast</span> <span class="op">&lt;-</span> <span class="fu">oceandatr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/oceandatr/man/get_features.html" class="external-link">get_features</a></span><span class="op">(</span>spatial_grid <span class="op">=</span> <span class="va">planning_rast</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create a "cost" to protecting a cell - just a uniform cost for this example</span></span>
<span><span class="va">cost_rast</span> <span class="op">&lt;-</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span><span class="va">planning_rast</span>, <span class="st">"cost"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Separate seamount data - we want to protect entire patches</span></span>
<span><span class="va">seamounts_rast</span> <span class="op">&lt;-</span> <span class="va">features_rast</span><span class="op">[[</span><span class="st">"seamounts"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">features_rast</span> <span class="op">&lt;-</span> <span class="va">features_rast</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">features_rast</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">features_rast</span><span class="op">)</span> <span class="op">!=</span> <span class="st">"seamounts"</span><span class="op">]</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<p>We can generate a locked-in layer that would represent an existing
MPA.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create a function to produce a square area</span></span>
<span><span class="va">create_area</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">spatial_grid</span>, <span class="va">mpa_size</span>, <span class="va">edge_offset</span><span class="op">)</span> <span class="op">{</span> </span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">spatial_grid</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"RasterLayer"</span>, <span class="st">"SpatRaster"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span> </span>
<span>    <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="va">spatial_grid</span>,</span>
<span>                vals <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="op">(</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">spatial_grid</span><span class="op">)</span><span class="op">*</span><span class="va">edge_offset</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                         <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="va">edge_offset</span><span class="op">)</span>, </span>
<span>                               <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">mpa_size</span><span class="op">)</span>, </span>
<span>                               <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="op">(</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">spatial_grid</span><span class="op">)</span><span class="op">-</span><span class="op">(</span><span class="va">edge_offset</span><span class="op">+</span><span class="va">mpa_size</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                             <span class="va">mpa_size</span><span class="op">)</span>, </span>
<span>                         <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="op">(</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">spatial_grid</span><span class="op">)</span><span class="op">*</span><span class="op">(</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">spatial_grid</span><span class="op">)</span><span class="op">-</span><span class="va">edge_offset</span><span class="op">-</span><span class="va">mpa_size</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">spatial_grid</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">==</span> <span class="st">"sf"</span><span class="op">)</span> <span class="op">{</span> </span>
<span>    <span class="va">sf_to_grid</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_make_grid.html" class="external-link">st_make_grid</a></span><span class="op">(</span><span class="va">spatial_grid</span>, cellsize <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_measures.html" class="external-link">st_area</a></span><span class="op">(</span><span class="va">spatial_grid</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">sf_centroid</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html" class="external-link">st_centroid</a></span><span class="op">(</span><span class="va">sf_to_grid</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html" class="external-link">st_coordinates</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>  </span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>X <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">X</span>, digits <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>, </span>
<span>                    Y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">Y</span>, digits <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># sf::st_make_grid changes the orientation of how cells are read - change them back</span></span>
<span>    <span class="va">sf_to_grid</span> <span class="op">&lt;-</span> <span class="va">sf_to_grid</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_cols.html" class="external-link">bind_cols</a></span><span class="op">(</span><span class="va">sf_centroid</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html" class="external-link">desc</a></span><span class="op">(</span><span class="va">Y</span><span class="op">)</span>, <span class="va">X</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">X</span>, <span class="op">-</span><span class="va">Y</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="va">cols_sf_to_grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">sf_centroid</span><span class="op">$</span><span class="va">X</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">rows_sf_to_grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">sf_centroid</span><span class="op">$</span><span class="va">Y</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="va">sf_to_grid</span> <span class="op">&lt;-</span> <span class="va">sf_to_grid</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/sf.html" class="external-link">st_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>layer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="op">(</span><span class="va">cols_sf_to_grid</span><span class="op">*</span><span class="va">edge_offset</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                         <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="va">edge_offset</span><span class="op">)</span>, </span>
<span>                               <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">mpa_size</span><span class="op">)</span>, </span>
<span>                               <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="op">(</span><span class="va">cols_sf_to_grid</span><span class="op">-</span><span class="op">(</span><span class="va">edge_offset</span><span class="op">+</span><span class="va">mpa_size</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                             <span class="va">mpa_size</span><span class="op">)</span>, </span>
<span>                         <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="op">(</span><span class="va">cols_sf_to_grid</span><span class="op">*</span><span class="op">(</span><span class="va">rows_sf_to_grid</span><span class="op">-</span><span class="va">edge_offset</span><span class="op">-</span><span class="va">mpa_size</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># the planning sf only includes polygons for the planning area (we need to remove them) so the number of cells matches the planning grid </span></span>
<span>    <span class="va">sf_to_grid</span> <span class="op">&lt;-</span> <span class="va">sf_to_grid</span><span class="op">[</span><span class="va">sf_to_grid</span><span class="op">$</span><span class="va">geometry</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">spatial_grid</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="op">]</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">sf_to_grid</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span>    <span class="va">sf_to_grid</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/relocate.html" class="external-link">relocate</a></span><span class="op">(</span><span class="va">layer</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create a fake MPA</span></span>
<span><span class="va">mpa_location</span> <span class="op">&lt;-</span> <span class="fu">create_area</span><span class="op">(</span><span class="va">planning_rast</span>, <span class="fl">20</span>, <span class="fl">50</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot fake MPA</span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mpa_location</span><span class="op">)</span></span></code></pre></div>
<p><img src="locked_in_out_files/figure-html/unnamed-chunk-3-1.png" width="700"></p>
<p>Now we can continue using <code>patchwise</code> to group seamount
areas so that entire seamount ranges are protected (and not portions of
seamounts).</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create seamount patches - seamount areas that touch are considered the same patch</span></span>
<span><span class="va">patches_rast</span> <span class="op">&lt;-</span> <span class="fu">patchwise</span><span class="fu">::</span><span class="fu"><a href="../reference/create_patches.html">create_patches</a></span><span class="op">(</span><span class="va">seamounts_rast</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create patches dataframe - this creates several constraints so that entire seamount units are protected together</span></span>
<span><span class="va">patches_df_rast</span> <span class="op">&lt;-</span> <span class="fu">patchwise</span><span class="fu">::</span><span class="fu"><a href="../reference/create_patch_df.html">create_patch_df</a></span><span class="op">(</span>spatial_grid <span class="op">=</span> <span class="va">planning_rast</span>, features <span class="op">=</span> <span class="va">features_rast</span>, patches <span class="op">=</span> <span class="va">patches_rast</span>, costs <span class="op">=</span> <span class="va">cost_rast</span>, locked_in <span class="op">=</span> <span class="va">mpa_location</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Processing patch 1 of 7"</span></span>
<span><span class="co">#&gt; [1] "Processing patch 2 of 7"</span></span>
<span><span class="co">#&gt; [1] "Processing patch 3 of 7"</span></span>
<span><span class="co">#&gt; [1] "Processing patch 4 of 7"</span></span>
<span><span class="co">#&gt; [1] "Processing patch 5 of 7"</span></span>
<span><span class="co">#&gt; [1] "Processing patch 6 of 7"</span></span>
<span><span class="co">#&gt; [1] "Processing patch 7 of 7"</span></span>
<span></span>
<span><span class="co"># Create boundary matrix for prioritizr</span></span>
<span><span class="va">boundary_matrix_rast</span> <span class="op">&lt;-</span> <span class="fu">patchwise</span><span class="fu">::</span><span class="fu"><a href="../reference/create_boundary_matrix.html">create_boundary_matrix</a></span><span class="op">(</span>spatial_grid <span class="op">=</span> <span class="va">planning_rast</span>, patches <span class="op">=</span> <span class="va">patches_rast</span>, patch_df <span class="op">=</span> <span class="va">patches_df_rast</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create targets for protection - let's just do 20% for each feature (including 20% of whole seamounts)</span></span>
<span><span class="va">targets_rast</span> <span class="op">&lt;-</span> <span class="fu">patchwise</span><span class="fu">::</span><span class="fu"><a href="../reference/features_targets.html">features_targets</a></span><span class="op">(</span>targets <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0.2</span>, <span class="op">(</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">nlyr</a></span><span class="op">(</span><span class="va">features_rast</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>, features <span class="op">=</span> <span class="va">features_rast</span>, pre_patches <span class="op">=</span> <span class="va">seamounts_rast</span>, locked_in <span class="op">=</span> <span class="va">mpa_location</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add these targets to targets for protection for the "constraints" we introduced to protect entire seamount units</span></span>
<span><span class="va">constraints_rast</span> <span class="op">&lt;-</span> <span class="fu">patchwise</span><span class="fu">::</span><span class="fu"><a href="../reference/constraints_targets.html">constraints_targets</a></span><span class="op">(</span>feature_targets <span class="op">=</span> <span class="va">targets_rast</span>, patch_df <span class="op">=</span> <span class="va">patches_df_rast</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Run the prioritization</span></span>
<span><span class="va">problem_rast</span> <span class="op">&lt;-</span> <span class="fu">prioritizr</span><span class="fu">::</span><span class="fu"><a href="https://prioritizr.net/reference/problem.html" class="external-link">problem</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">patches_df_rast</span>, features <span class="op">=</span> <span class="va">constraints_rast</span><span class="op">$</span><span class="va">feature</span>, cost_column <span class="op">=</span> <span class="st">"cost"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">prioritizr</span><span class="fu">::</span><span class="fu"><a href="https://prioritizr.net/reference/add_min_set_objective.html" class="external-link">add_min_set_objective</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">prioritizr</span><span class="fu">::</span><span class="fu"><a href="https://prioritizr.net/reference/add_manual_targets.html" class="external-link">add_manual_targets</a></span><span class="op">(</span><span class="va">constraints_rast</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">prioritizr</span><span class="fu">::</span><span class="fu"><a href="https://prioritizr.net/reference/add_binary_decisions.html" class="external-link">add_binary_decisions</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">prioritizr</span><span class="fu">::</span><span class="fu"><a href="https://prioritizr.net/reference/add_boundary_penalties.html" class="external-link">add_boundary_penalties</a></span><span class="op">(</span>penalty <span class="op">=</span> <span class="fl">0.000002</span>, data <span class="op">=</span> <span class="va">boundary_matrix_rast</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">prioritizr</span><span class="fu">::</span><span class="fu"><a href="https://prioritizr.net/reference/add_gurobi_solver.html" class="external-link">add_gurobi_solver</a></span><span class="op">(</span>gap <span class="op">=</span> <span class="fl">0.1</span>, threads <span class="op">=</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html" class="external-link">detectCores</a></span><span class="op">(</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Solve the prioritization</span></span>
<span><span class="va">solution_rast</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/solve.html" class="external-link">solve</a></span><span class="op">(</span><span class="va">problem_rast</span><span class="op">)</span></span>
<span><span class="co">#&gt; Gurobi Optimizer version 10.0.0 build v10.0.0rc2 (mac64[arm])</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; CPU model: Apple M1 Max</span></span>
<span><span class="co">#&gt; Thread count: 10 physical cores, 10 logical processors, using up to 9 threads</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Optimize a model with 76296 rows, 56073 columns and 214386 nonzeros</span></span>
<span><span class="co">#&gt; Model fingerprint: 0xc25c3da2</span></span>
<span><span class="co">#&gt; Variable types: 0 continuous, 56073 integer (56073 binary)</span></span>
<span><span class="co">#&gt; Coefficient statistics:</span></span>
<span><span class="co">#&gt;   Matrix range     [1e+00, 5e+02]</span></span>
<span><span class="co">#&gt;   Objective range  [2e-02, 5e+02]</span></span>
<span><span class="co">#&gt;   Bounds range     [1e+00, 1e+00]</span></span>
<span><span class="co">#&gt;   RHS range        [1e+00, 4e+03]</span></span>
<span><span class="co">#&gt; Found heuristic solution: objective 3740.9750000</span></span>
<span><span class="co">#&gt; Presolve removed 2915 rows and 1615 columns</span></span>
<span><span class="co">#&gt; Presolve time: 0.73s</span></span>
<span><span class="co">#&gt; Presolved: 73381 rows, 54458 columns, 207121 nonzeros</span></span>
<span><span class="co">#&gt; Variable types: 0 continuous, 54458 integer (54458 binary)</span></span>
<span><span class="co">#&gt; Root relaxation presolved: 73381 rows, 54458 columns, 207121 nonzeros</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Deterministic concurrent LP optimizer: primal and dual simplex</span></span>
<span><span class="co">#&gt; Showing first log only...</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Warning: Markowitz tolerance tightened to 0.25</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Root simplex log...</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Iteration    Objective       Primal Inf.    Dual Inf.      Time</span></span>
<span><span class="co">#&gt;    75213    3.7292223e+03   0.000000e+00   2.789111e+03      5s</span></span>
<span><span class="co">#&gt;    87728    3.7247301e+03   0.000000e+00   1.163946e+03     10s</span></span>
<span><span class="co">#&gt;    92403    3.7234152e+03   0.000000e+00   1.845726e+03     15s</span></span>
<span><span class="co">#&gt;    96928    3.7230790e+03   0.000000e+00   3.650962e+03     20s</span></span>
<span><span class="co">#&gt;   102263    3.7230237e+03   0.000000e+00   3.047628e+04     25s</span></span>
<span><span class="co">#&gt;   108682    3.7228560e+03   0.000000e+00   5.559902e+03     30s</span></span>
<span><span class="co">#&gt;   112725    3.7228415e+03   0.000000e+00   7.076330e+04     35s</span></span>
<span><span class="co">#&gt;   116651    3.7228349e+03   0.000000e+00   5.104532e+04     40s</span></span>
<span><span class="co">#&gt;   119311    3.7228313e+03   0.000000e+00   2.999021e+03     45s</span></span>
<span><span class="co">#&gt;   121651    3.7228295e+03   0.000000e+00   6.317554e+02     50s</span></span>
<span><span class="co">#&gt; Concurrent spin time: 0.02s</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Solved with dual simplex</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Root simplex log...</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Iteration    Objective       Primal Inf.    Dual Inf.      Time</span></span>
<span><span class="co">#&gt;    69647    3.7229317e+03   0.000000e+00   0.000000e+00     53s</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Root relaxation: objective 3.722932e+03, 69647 iterations, 52.00 seconds (151.93 work units)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     Nodes    |    Current Node    |     Objective Bounds      |     Work</span></span>
<span><span class="co">#&gt;  Expl Unexpl |  Obj  Depth IntInf | Incumbent    BestBd   Gap | It/Node Time</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;      0     0 3722.93174    0 50601 3740.97500 3722.93174  0.48%     -   53s</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Explored 1 nodes (69735 simplex iterations) in 53.18 seconds (153.73 work units)</span></span>
<span><span class="co">#&gt; Thread count was 9 (of 10 available processors)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Solution count 1: 3740.98 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Optimal solution found (tolerance 1.00e-01)</span></span>
<span><span class="co">#&gt; Best objective 3.740975000000e+03, best bound 3.722931735863e+03, gap 0.4823%</span></span>
<span></span>
<span><span class="co"># Convert the prioritization into a more digestible format</span></span>
<span><span class="va">result_rast</span> <span class="op">&lt;-</span> <span class="fu">patchwise</span><span class="fu">::</span><span class="fu"><a href="../reference/convert_solution.html">convert_solution</a></span><span class="op">(</span>solution <span class="op">=</span> <span class="va">solution_rast</span>, patch_df <span class="op">=</span> <span class="va">patches_df_rast</span>, spatial_grid <span class="op">=</span> <span class="va">planning_rast</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Show the results</span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">result_rast</span><span class="op">)</span></span></code></pre></div>
<p><img src="locked_in_out_files/figure-html/unnamed-chunk-4-1.png" width="700"></p>
<p>The areas in green are those selected by the prioritization for
protection. We can clearly see the locked-in area (the green square) was
included!</p>
</div>
<div class="section level2">
<h2 id="implement-locked-out-areas-using-a-raster-input">Implement locked-out areas using a <code>raster</code> input<a class="anchor" aria-label="anchor" href="#implement-locked-out-areas-using-a-raster-input"></a>
</h2>
<p>What if we want to note of an area that we cannot consider for
protection? We can include a “locked-out” area. We repeat the example
above, but this time we will exclude this area from the prioritization
results.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create a fake locked-out area</span></span>
<span><span class="va">no_protection</span> <span class="op">&lt;-</span> <span class="fu">create_area</span><span class="op">(</span><span class="va">planning_rast</span>, <span class="fl">20</span>, <span class="fl">95</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot fake locked-out area</span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">no_protection</span><span class="op">)</span></span></code></pre></div>
<p><img src="locked_in_out_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
<p>Now we can continue using <code>patchwise</code> to group seamount
areas so that entire seamount ranges are protected (and not portions of
seamounts).</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create patches dataframe - this creates several constraints so that entire seamount units are protected together</span></span>
<span><span class="va">patches_df_rast</span> <span class="op">&lt;-</span> <span class="fu">patchwise</span><span class="fu">::</span><span class="fu"><a href="../reference/create_patch_df.html">create_patch_df</a></span><span class="op">(</span>spatial_grid <span class="op">=</span> <span class="va">planning_rast</span>, features <span class="op">=</span> <span class="va">features_rast</span>, patches <span class="op">=</span> <span class="va">patches_rast</span>, costs <span class="op">=</span> <span class="va">cost_rast</span>, locked_out <span class="op">=</span> <span class="va">no_protection</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Processing patch 1 of 7"</span></span>
<span><span class="co">#&gt; [1] "Processing patch 2 of 7"</span></span>
<span><span class="co">#&gt; [1] "Processing patch 3 of 7"</span></span>
<span><span class="co">#&gt; [1] "Processing patch 4 of 7"</span></span>
<span><span class="co">#&gt; [1] "Processing patch 5 of 7"</span></span>
<span><span class="co">#&gt; [1] "Processing patch 6 of 7"</span></span>
<span><span class="co">#&gt; [1] "Processing patch 7 of 7"</span></span>
<span></span>
<span><span class="co"># Create boundary matrix for prioritizr</span></span>
<span><span class="va">boundary_matrix_rast</span> <span class="op">&lt;-</span> <span class="fu">patchwise</span><span class="fu">::</span><span class="fu"><a href="../reference/create_boundary_matrix.html">create_boundary_matrix</a></span><span class="op">(</span>spatial_grid <span class="op">=</span> <span class="va">planning_rast</span>, patches <span class="op">=</span> <span class="va">patches_rast</span>, patch_df <span class="op">=</span> <span class="va">patches_df_rast</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create targets for protection - let's just do 20% for each feature (including 20% of whole seamounts)</span></span>
<span><span class="va">targets_rast</span> <span class="op">&lt;-</span> <span class="fu">patchwise</span><span class="fu">::</span><span class="fu"><a href="../reference/features_targets.html">features_targets</a></span><span class="op">(</span>targets <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0.2</span>, <span class="op">(</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">nlyr</a></span><span class="op">(</span><span class="va">features_rast</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>, features <span class="op">=</span> <span class="va">features_rast</span>, pre_patches <span class="op">=</span> <span class="va">seamounts_rast</span>, locked_out <span class="op">=</span> <span class="va">no_protection</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add these targets to targets for protection for the "constraints" we introduced to protect entire seamount units</span></span>
<span><span class="va">constraints_rast</span> <span class="op">&lt;-</span> <span class="fu">patchwise</span><span class="fu">::</span><span class="fu"><a href="../reference/constraints_targets.html">constraints_targets</a></span><span class="op">(</span>feature_targets <span class="op">=</span> <span class="va">targets_rast</span>, patch_df <span class="op">=</span> <span class="va">patches_df_rast</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Run the prioritization</span></span>
<span><span class="va">problem_rast</span> <span class="op">&lt;-</span> <span class="fu">prioritizr</span><span class="fu">::</span><span class="fu"><a href="https://prioritizr.net/reference/problem.html" class="external-link">problem</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">patches_df_rast</span>, features <span class="op">=</span> <span class="va">constraints_rast</span><span class="op">$</span><span class="va">feature</span>, cost_column <span class="op">=</span> <span class="st">"cost"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">prioritizr</span><span class="fu">::</span><span class="fu"><a href="https://prioritizr.net/reference/add_min_set_objective.html" class="external-link">add_min_set_objective</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">prioritizr</span><span class="fu">::</span><span class="fu"><a href="https://prioritizr.net/reference/add_manual_targets.html" class="external-link">add_manual_targets</a></span><span class="op">(</span><span class="va">constraints_rast</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">prioritizr</span><span class="fu">::</span><span class="fu"><a href="https://prioritizr.net/reference/add_binary_decisions.html" class="external-link">add_binary_decisions</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">prioritizr</span><span class="fu">::</span><span class="fu"><a href="https://prioritizr.net/reference/add_boundary_penalties.html" class="external-link">add_boundary_penalties</a></span><span class="op">(</span>penalty <span class="op">=</span> <span class="fl">0.000002</span>, data <span class="op">=</span> <span class="va">boundary_matrix_rast</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">prioritizr</span><span class="fu">::</span><span class="fu"><a href="https://prioritizr.net/reference/add_gurobi_solver.html" class="external-link">add_gurobi_solver</a></span><span class="op">(</span>gap <span class="op">=</span> <span class="fl">0.1</span>, threads <span class="op">=</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html" class="external-link">detectCores</a></span><span class="op">(</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Solve the prioritization</span></span>
<span><span class="va">solution_rast</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/solve.html" class="external-link">solve</a></span><span class="op">(</span><span class="va">problem_rast</span><span class="op">)</span></span>
<span><span class="co">#&gt; Gurobi Optimizer version 10.0.0 build v10.0.0rc2 (mac64[arm])</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; CPU model: Apple M1 Max</span></span>
<span><span class="co">#&gt; Thread count: 10 physical cores, 10 logical processors, using up to 9 threads</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Optimize a model with 76296 rows, 56073 columns and 214385 nonzeros</span></span>
<span><span class="co">#&gt; Model fingerprint: 0xf7b92fc5</span></span>
<span><span class="co">#&gt; Variable types: 0 continuous, 56073 integer (56073 binary)</span></span>
<span><span class="co">#&gt; Coefficient statistics:</span></span>
<span><span class="co">#&gt;   Matrix range     [1e+00, 5e+02]</span></span>
<span><span class="co">#&gt;   Objective range  [2e-02, 5e+02]</span></span>
<span><span class="co">#&gt;   Bounds range     [1e+00, 1e+00]</span></span>
<span><span class="co">#&gt;   RHS range        [1e+00, 4e+03]</span></span>
<span><span class="co">#&gt; Found heuristic solution: objective 3733.8850000</span></span>
<span><span class="co">#&gt; Presolve removed 2633 rows and 1557 columns</span></span>
<span><span class="co">#&gt; Presolve time: 0.58s</span></span>
<span><span class="co">#&gt; Presolved: 73663 rows, 54516 columns, 207723 nonzeros</span></span>
<span><span class="co">#&gt; Variable types: 0 continuous, 54516 integer (54516 binary)</span></span>
<span><span class="co">#&gt; Root relaxation presolved: 73663 rows, 54516 columns, 207723 nonzeros</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Deterministic concurrent LP optimizer: primal and dual simplex</span></span>
<span><span class="co">#&gt; Showing first log only...</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Warning: Markowitz tolerance tightened to 0.5</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Root simplex log...</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Iteration    Objective       Primal Inf.    Dual Inf.      Time</span></span>
<span><span class="co">#&gt;    80503    3.7267058e+03   0.000000e+00   9.319456e+02      5s</span></span>
<span><span class="co">#&gt;    89183    3.7240572e+03   0.000000e+00   1.563903e+03     10s</span></span>
<span><span class="co">#&gt;    94213    3.7235126e+03   0.000000e+00   1.365684e+03     15s</span></span>
<span><span class="co">#&gt;    98398    3.7226996e+03   0.000000e+00   1.479564e+04     20s</span></span>
<span><span class="co">#&gt;   102133    3.7219730e+03   0.000000e+00   7.732695e+03     25s</span></span>
<span><span class="co">#&gt;   107398    3.7216625e+03   0.000000e+00   8.573821e+02     30s</span></span>
<span><span class="co">#&gt;   110828    3.7214911e+03   0.000000e+00   2.892824e+03     35s</span></span>
<span><span class="co">#&gt; Concurrent spin time: 0.00s</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Solved with dual simplex</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Root simplex log...</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Iteration    Objective       Primal Inf.    Dual Inf.      Time</span></span>
<span><span class="co">#&gt;    55179    3.7213346e+03   0.000000e+00   0.000000e+00     36s</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Root relaxation: objective 3.721335e+03, 55179 iterations, 35.78 seconds (101.60 work units)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     Nodes    |    Current Node    |     Objective Bounds      |     Work</span></span>
<span><span class="co">#&gt;  Expl Unexpl |  Obj  Depth IntInf | Incumbent    BestBd   Gap | It/Node Time</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;      0     0 3721.33461    0 49528 3733.88500 3721.33461  0.34%     -   36s</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Explored 1 nodes (55285 simplex iterations) in 36.86 seconds (103.27 work units)</span></span>
<span><span class="co">#&gt; Thread count was 9 (of 10 available processors)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Solution count 1: 3733.89 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Optimal solution found (tolerance 1.00e-01)</span></span>
<span><span class="co">#&gt; Best objective 3.733885000000e+03, best bound 3.721335000000e+03, gap 0.3361%</span></span>
<span></span>
<span><span class="co"># Convert the prioritization into a more digestible format</span></span>
<span><span class="va">result_rast</span> <span class="op">&lt;-</span> <span class="fu">patchwise</span><span class="fu">::</span><span class="fu"><a href="../reference/convert_solution.html">convert_solution</a></span><span class="op">(</span>solution <span class="op">=</span> <span class="va">solution_rast</span>, patch_df <span class="op">=</span> <span class="va">patches_df_rast</span>, spatial_grid <span class="op">=</span> <span class="va">planning_rast</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Show the results</span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">result_rast</span><span class="op">)</span></span></code></pre></div>
<p><img src="locked_in_out_files/figure-html/unnamed-chunk-6-1.png" width="700"></p>
<p>Great! The area that we don’t want to include in the solution is
removed!</p>
</div>
<div class="section level2">
<h2 id="implement-locked-in-and-locked-out-areas-using-a-raster-input">Implement locked-in and locked-out areas using a <code>raster</code>
input<a class="anchor" aria-label="anchor" href="#implement-locked-in-and-locked-out-areas-using-a-raster-input"></a>
</h2>
<p>We can also run a scenario in which we have both locked-in and
locked-out areas.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create patches dataframe - this creates several constraints so that entire seamount units are protected together</span></span>
<span><span class="va">patches_df_rast</span> <span class="op">&lt;-</span> <span class="fu">patchwise</span><span class="fu">::</span><span class="fu"><a href="../reference/create_patch_df.html">create_patch_df</a></span><span class="op">(</span>spatial_grid <span class="op">=</span> <span class="va">planning_rast</span>, features <span class="op">=</span> <span class="va">features_rast</span>, patches <span class="op">=</span> <span class="va">patches_rast</span>, costs <span class="op">=</span> <span class="va">cost_rast</span>, locked_in <span class="op">=</span> <span class="va">mpa_location</span>, locked_out <span class="op">=</span> <span class="va">no_protection</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Processing patch 1 of 7"</span></span>
<span><span class="co">#&gt; [1] "Processing patch 2 of 7"</span></span>
<span><span class="co">#&gt; [1] "Processing patch 3 of 7"</span></span>
<span><span class="co">#&gt; [1] "Processing patch 4 of 7"</span></span>
<span><span class="co">#&gt; [1] "Processing patch 5 of 7"</span></span>
<span><span class="co">#&gt; [1] "Processing patch 6 of 7"</span></span>
<span><span class="co">#&gt; [1] "Processing patch 7 of 7"</span></span>
<span></span>
<span><span class="co"># Create boundary matrix for prioritizr</span></span>
<span><span class="va">boundary_matrix_rast</span> <span class="op">&lt;-</span> <span class="fu">patchwise</span><span class="fu">::</span><span class="fu"><a href="../reference/create_boundary_matrix.html">create_boundary_matrix</a></span><span class="op">(</span>spatial_grid <span class="op">=</span> <span class="va">planning_rast</span>, patches <span class="op">=</span> <span class="va">patches_rast</span>, patch_df <span class="op">=</span> <span class="va">patches_df_rast</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create targets for protection - let's just do 20% for each feature (including 20% of whole seamounts)</span></span>
<span><span class="va">targets_rast</span> <span class="op">&lt;-</span> <span class="fu">patchwise</span><span class="fu">::</span><span class="fu"><a href="../reference/features_targets.html">features_targets</a></span><span class="op">(</span>targets <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0.2</span>, <span class="op">(</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">nlyr</a></span><span class="op">(</span><span class="va">features_rast</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>, features <span class="op">=</span> <span class="va">features_rast</span>, pre_patches <span class="op">=</span> <span class="va">seamounts_rast</span>, locked_in <span class="op">=</span> <span class="va">mpa_location</span>, locked_out <span class="op">=</span> <span class="va">no_protection</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add these targets to targets for protection for the "constraints" we introduced to protect entire seamount units</span></span>
<span><span class="va">constraints_rast</span> <span class="op">&lt;-</span> <span class="fu">patchwise</span><span class="fu">::</span><span class="fu"><a href="../reference/constraints_targets.html">constraints_targets</a></span><span class="op">(</span>feature_targets <span class="op">=</span> <span class="va">targets_rast</span>, patch_df <span class="op">=</span> <span class="va">patches_df_rast</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Run the prioritization</span></span>
<span><span class="va">problem_rast</span> <span class="op">&lt;-</span> <span class="fu">prioritizr</span><span class="fu">::</span><span class="fu"><a href="https://prioritizr.net/reference/problem.html" class="external-link">problem</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">patches_df_rast</span>, features <span class="op">=</span> <span class="va">constraints_rast</span><span class="op">$</span><span class="va">feature</span>, cost_column <span class="op">=</span> <span class="st">"cost"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">prioritizr</span><span class="fu">::</span><span class="fu"><a href="https://prioritizr.net/reference/add_min_set_objective.html" class="external-link">add_min_set_objective</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">prioritizr</span><span class="fu">::</span><span class="fu"><a href="https://prioritizr.net/reference/add_manual_targets.html" class="external-link">add_manual_targets</a></span><span class="op">(</span><span class="va">constraints_rast</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">prioritizr</span><span class="fu">::</span><span class="fu"><a href="https://prioritizr.net/reference/add_binary_decisions.html" class="external-link">add_binary_decisions</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">prioritizr</span><span class="fu">::</span><span class="fu"><a href="https://prioritizr.net/reference/add_boundary_penalties.html" class="external-link">add_boundary_penalties</a></span><span class="op">(</span>penalty <span class="op">=</span> <span class="fl">0.000002</span>, data <span class="op">=</span> <span class="va">boundary_matrix_rast</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">prioritizr</span><span class="fu">::</span><span class="fu"><a href="https://prioritizr.net/reference/add_gurobi_solver.html" class="external-link">add_gurobi_solver</a></span><span class="op">(</span>gap <span class="op">=</span> <span class="fl">0.1</span>, threads <span class="op">=</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html" class="external-link">detectCores</a></span><span class="op">(</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Solve the prioritization</span></span>
<span><span class="va">solution_rast</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/solve.html" class="external-link">solve</a></span><span class="op">(</span><span class="va">problem_rast</span><span class="op">)</span></span>
<span><span class="co">#&gt; Gurobi Optimizer version 10.0.0 build v10.0.0rc2 (mac64[arm])</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; CPU model: Apple M1 Max</span></span>
<span><span class="co">#&gt; Thread count: 10 physical cores, 10 logical processors, using up to 9 threads</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Optimize a model with 76297 rows, 56073 columns and 214786 nonzeros</span></span>
<span><span class="co">#&gt; Model fingerprint: 0x8acc3e12</span></span>
<span><span class="co">#&gt; Variable types: 0 continuous, 56073 integer (56073 binary)</span></span>
<span><span class="co">#&gt; Coefficient statistics:</span></span>
<span><span class="co">#&gt;   Matrix range     [1e+00, 5e+02]</span></span>
<span><span class="co">#&gt;   Objective range  [2e-02, 5e+02]</span></span>
<span><span class="co">#&gt;   Bounds range     [1e+00, 1e+00]</span></span>
<span><span class="co">#&gt;   RHS range        [1e+00, 4e+03]</span></span>
<span><span class="co">#&gt; Found heuristic solution: objective 3741.0600000</span></span>
<span><span class="co">#&gt; Presolve removed 4596 rows and 2855 columns</span></span>
<span><span class="co">#&gt; Presolve time: 0.65s</span></span>
<span><span class="co">#&gt; Presolved: 71701 rows, 53218 columns, 202309 nonzeros</span></span>
<span><span class="co">#&gt; Variable types: 0 continuous, 53218 integer (53218 binary)</span></span>
<span><span class="co">#&gt; Root relaxation presolved: 71701 rows, 53218 columns, 202309 nonzeros</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Deterministic concurrent LP optimizer: primal and dual simplex</span></span>
<span><span class="co">#&gt; Showing first log only...</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Warning: Markowitz tolerance tightened to 0.5</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Root simplex log...</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Iteration    Objective       Primal Inf.    Dual Inf.      Time</span></span>
<span><span class="co">#&gt;    77801    3.7276475e+03   0.000000e+00   1.812350e+03      5s</span></span>
<span><span class="co">#&gt;    86281    3.7269675e+03   0.000000e+00   3.586826e+02     10s</span></span>
<span><span class="co">#&gt;    96403    3.7257502e+03   0.000000e+00   3.500927e+03     15s</span></span>
<span><span class="co">#&gt;   106503    3.7231165e+03   0.000000e+00   2.218578e+06     20s</span></span>
<span><span class="co">#&gt;   111235    3.7230565e+03   0.000000e+00   1.763970e+03     25s</span></span>
<span><span class="co">#&gt;   115800    3.7230378e+03   0.000000e+00   1.658229e+03     30s</span></span>
<span><span class="co">#&gt;   119076    3.7230250e+03   0.000000e+00   5.543245e+02     35s</span></span>
<span><span class="co">#&gt;   122672    3.7230076e+03   0.000000e+00   1.493952e+03     40s</span></span>
<span><span class="co">#&gt;   125436    3.7229934e+03   0.000000e+00   1.390157e+03     45s</span></span>
<span><span class="co">#&gt;   127676    3.7229895e+03   0.000000e+00   6.278646e+02     50s</span></span>
<span><span class="co">#&gt; Concurrent spin time: 0.00s</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Solved with dual simplex</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Root simplex log...</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Iteration    Objective       Primal Inf.    Dual Inf.      Time</span></span>
<span><span class="co">#&gt;    64341    3.7230710e+03   0.000000e+00   0.000000e+00     51s</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Root relaxation: objective 3.723071e+03, 64341 iterations, 50.58 seconds (144.87 work units)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     Nodes    |    Current Node    |     Objective Bounds      |     Work</span></span>
<span><span class="co">#&gt;  Expl Unexpl |  Obj  Depth IntInf | Incumbent    BestBd   Gap | It/Node Time</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;      0     0 3723.07098    0 49364 3741.06000 3723.07098  0.48%     -   51s</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Explored 1 nodes (64433 simplex iterations) in 51.70 seconds (146.66 work units)</span></span>
<span><span class="co">#&gt; Thread count was 9 (of 10 available processors)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Solution count 1: 3741.06 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Optimal solution found (tolerance 1.00e-01)</span></span>
<span><span class="co">#&gt; Best objective 3.741060000000e+03, best bound 3.723070980814e+03, gap 0.4809%</span></span>
<span></span>
<span><span class="co"># Convert the prioritization into a more digestible format</span></span>
<span><span class="va">result_rast</span> <span class="op">&lt;-</span> <span class="fu">patchwise</span><span class="fu">::</span><span class="fu"><a href="../reference/convert_solution.html">convert_solution</a></span><span class="op">(</span>solution <span class="op">=</span> <span class="va">solution_rast</span>, patch_df <span class="op">=</span> <span class="va">patches_df_rast</span>, spatial_grid <span class="op">=</span> <span class="va">planning_rast</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Show the results</span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">result_rast</span><span class="op">)</span></span></code></pre></div>
<p><img src="locked_in_out_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
<p>It looks like we got the results we wanted - the locked-in areas were
included in the prioritization output as an area to protect, and the
locked-out areas were not included!</p>
</div>
<div class="section level2">
<h2 id="implement-locked-in-areas-using-an-sf-input">Implement locked-in areas using an <code>sf</code> input<a class="anchor" aria-label="anchor" href="#implement-locked-in-areas-using-an-sf-input"></a>
</h2>
<p>To generate our data for this example, we will use data from Bermuda
generated via <code>oceandatr</code>.</p>
<p>We can generate a locked-in layer that would represent an existing
MPA.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create a fake MPA</span></span>
<span><span class="va">mpa_location</span> <span class="op">&lt;-</span> <span class="fu">create_area</span><span class="op">(</span><span class="va">planning_sf</span>, <span class="fl">20</span>, <span class="fl">50</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot fake MPA</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mpa_location</span>, main <span class="op">=</span> <span class="cn">NULL</span>, border <span class="op">=</span> <span class="cn">F</span><span class="op">)</span></span></code></pre></div>
<p><img src="locked_in_out_files/figure-html/unnamed-chunk-9-1.png" width="700"></p>
<p>Now we can continue using <code>patchwise</code> to group seamount
areas so that entire seamount ranges are protected (and not portions of
seamounts).</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create seamount patches - seamount areas that touch are considered the same patch</span></span>
<span><span class="va">patches_sf</span> <span class="op">&lt;-</span> <span class="fu">patchwise</span><span class="fu">::</span><span class="fu"><a href="../reference/create_patches.html">create_patches</a></span><span class="op">(</span><span class="va">seamounts_sf</span>, spatial_grid <span class="op">=</span> <span class="va">planning_sf</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create patches dataframe - this creates several constraints so that entire seamount units are protected together</span></span>
<span><span class="va">patches_df_sf</span> <span class="op">&lt;-</span> <span class="fu">patchwise</span><span class="fu">::</span><span class="fu"><a href="../reference/create_patch_df.html">create_patch_df</a></span><span class="op">(</span>spatial_grid <span class="op">=</span> <span class="va">planning_sf</span>, features <span class="op">=</span> <span class="va">features_sf</span>, patches <span class="op">=</span> <span class="va">patches_sf</span>, costs <span class="op">=</span> <span class="va">cost_sf</span>, locked_in <span class="op">=</span> <span class="va">mpa_location</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Processing patch 1 of 7"</span></span>
<span><span class="co">#&gt; [1] "Processing patch 2 of 7"</span></span>
<span><span class="co">#&gt; [1] "Processing patch 3 of 7"</span></span>
<span><span class="co">#&gt; [1] "Processing patch 4 of 7"</span></span>
<span><span class="co">#&gt; [1] "Processing patch 5 of 7"</span></span>
<span><span class="co">#&gt; [1] "Processing patch 6 of 7"</span></span>
<span><span class="co">#&gt; [1] "Processing patch 7 of 7"</span></span>
<span></span>
<span><span class="co"># Create boundary matrix for prioritizr</span></span>
<span><span class="va">boundary_matrix_sf</span> <span class="op">&lt;-</span> <span class="fu">patchwise</span><span class="fu">::</span><span class="fu"><a href="../reference/create_boundary_matrix.html">create_boundary_matrix</a></span><span class="op">(</span>spatial_grid <span class="op">=</span> <span class="va">planning_sf</span>, patches <span class="op">=</span> <span class="va">patches_sf</span>, patch_df <span class="op">=</span> <span class="va">patches_df_sf</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create targets for protection - let's just do 20% for each feature (including 20% of whole seamounts)</span></span>
<span><span class="va">targets_sf</span> <span class="op">&lt;-</span> <span class="fu">patchwise</span><span class="fu">::</span><span class="fu"><a href="../reference/features_targets.html">features_targets</a></span><span class="op">(</span>targets <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0.2</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">features_sf</span><span class="op">)</span><span class="op">)</span>, features <span class="op">=</span> <span class="va">features_sf</span>, pre_patches <span class="op">=</span> <span class="va">seamounts_sf</span>, locked_in <span class="op">=</span> <span class="va">mpa_location</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add these targets to targets for protection for the "constraints" we introduced to protect entire seamount units</span></span>
<span><span class="va">constraints_sf</span> <span class="op">&lt;-</span> <span class="fu">patchwise</span><span class="fu">::</span><span class="fu"><a href="../reference/constraints_targets.html">constraints_targets</a></span><span class="op">(</span>feature_targets <span class="op">=</span> <span class="va">targets_sf</span>, patch_df <span class="op">=</span> <span class="va">patches_df_sf</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Run the prioritization</span></span>
<span><span class="va">problem_sf</span> <span class="op">&lt;-</span> <span class="fu">prioritizr</span><span class="fu">::</span><span class="fu"><a href="https://prioritizr.net/reference/problem.html" class="external-link">problem</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">patches_df_sf</span>, features <span class="op">=</span> <span class="va">constraints_sf</span><span class="op">$</span><span class="va">feature</span>, cost_column <span class="op">=</span> <span class="st">"cost"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">prioritizr</span><span class="fu">::</span><span class="fu"><a href="https://prioritizr.net/reference/add_min_set_objective.html" class="external-link">add_min_set_objective</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">prioritizr</span><span class="fu">::</span><span class="fu"><a href="https://prioritizr.net/reference/add_manual_targets.html" class="external-link">add_manual_targets</a></span><span class="op">(</span><span class="va">constraints_sf</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">prioritizr</span><span class="fu">::</span><span class="fu"><a href="https://prioritizr.net/reference/add_binary_decisions.html" class="external-link">add_binary_decisions</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">prioritizr</span><span class="fu">::</span><span class="fu"><a href="https://prioritizr.net/reference/add_boundary_penalties.html" class="external-link">add_boundary_penalties</a></span><span class="op">(</span>penalty <span class="op">=</span> <span class="fl">0.000002</span>, data <span class="op">=</span> <span class="va">boundary_matrix_sf</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">prioritizr</span><span class="fu">::</span><span class="fu"><a href="https://prioritizr.net/reference/add_gurobi_solver.html" class="external-link">add_gurobi_solver</a></span><span class="op">(</span>gap <span class="op">=</span> <span class="fl">0.1</span>, threads <span class="op">=</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html" class="external-link">detectCores</a></span><span class="op">(</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Solve the prioritization</span></span>
<span><span class="va">solution_sf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/solve.html" class="external-link">solve</a></span><span class="op">(</span><span class="va">problem_sf</span><span class="op">)</span></span>
<span><span class="co">#&gt; Gurobi Optimizer version 10.0.0 build v10.0.0rc2 (mac64[arm])</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; CPU model: Apple M1 Max</span></span>
<span><span class="co">#&gt; Thread count: 10 physical cores, 10 logical processors, using up to 9 threads</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Optimize a model with 76981 rows, 56170 columns and 218036 nonzeros</span></span>
<span><span class="co">#&gt; Model fingerprint: 0xfea2ae20</span></span>
<span><span class="co">#&gt; Variable types: 0 continuous, 56170 integer (56170 binary)</span></span>
<span><span class="co">#&gt; Coefficient statistics:</span></span>
<span><span class="co">#&gt;   Matrix range     [1e+00, 6e+02]</span></span>
<span><span class="co">#&gt;   Objective range  [2e-02, 6e+02]</span></span>
<span><span class="co">#&gt;   Bounds range     [1e+00, 1e+00]</span></span>
<span><span class="co">#&gt;   RHS range        [1e+00, 4e+03]</span></span>
<span><span class="co">#&gt; Found heuristic solution: objective 3732.8950000</span></span>
<span><span class="co">#&gt; Presolve removed 2637 rows and 1617 columns</span></span>
<span><span class="co">#&gt; Presolve time: 0.87s</span></span>
<span><span class="co">#&gt; Presolved: 74344 rows, 54553 columns, 211669 nonzeros</span></span>
<span><span class="co">#&gt; Variable types: 0 continuous, 54553 integer (54553 binary)</span></span>
<span><span class="co">#&gt; Found heuristic solution: objective 3732.8900000</span></span>
<span><span class="co">#&gt; Root relaxation presolve removed 334 rows and 0 columns</span></span>
<span><span class="co">#&gt; Root relaxation presolved: 74010 rows, 54553 columns, 210667 nonzeros</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Deterministic concurrent LP optimizer: primal and dual simplex</span></span>
<span><span class="co">#&gt; Showing first log only...</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Warning: Markowitz tolerance tightened to 0.25</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Root simplex log...</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Iteration    Objective       Primal Inf.    Dual Inf.      Time</span></span>
<span><span class="co">#&gt;    73438    3.7232741e+03   0.000000e+00   2.463629e+03      5s</span></span>
<span><span class="co">#&gt;    83438    3.7226878e+03   0.000000e+00   1.125802e+04     10s</span></span>
<span><span class="co">#&gt;    90534    3.7220374e+03   0.000000e+00   4.925018e+03     15s</span></span>
<span><span class="co">#&gt;    95780    3.7208750e+03   0.000000e+00   5.463111e+03     20s</span></span>
<span><span class="co">#&gt;   100604    3.7206460e+03   0.000000e+00   2.149428e+03     25s</span></span>
<span><span class="co">#&gt;   106034    3.7200822e+03   0.000000e+00   3.551270e+03     30s</span></span>
<span><span class="co">#&gt;   112440    3.7199918e+03   0.000000e+00   1.828958e+05     35s</span></span>
<span><span class="co">#&gt;   116340    3.7199773e+03   0.000000e+00   6.657439e+03     40s</span></span>
<span><span class="co">#&gt;   119526    3.7199618e+03   0.000000e+00   1.319917e+03     45s</span></span>
<span><span class="co">#&gt;   121766    3.7199549e+03   0.000000e+00   1.983493e+03     50s</span></span>
<span><span class="co">#&gt; Concurrent spin time: 0.00s</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Solved with dual simplex</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Root simplex log...</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Iteration    Objective       Primal Inf.    Dual Inf.      Time</span></span>
<span><span class="co">#&gt;    58008    3.7200450e+03   0.000000e+00   0.000000e+00     52s</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Root relaxation: objective 3.720045e+03, 58008 iterations, 51.32 seconds (144.48 work units)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     Nodes    |    Current Node    |     Objective Bounds      |     Work</span></span>
<span><span class="co">#&gt;  Expl Unexpl |  Obj  Depth IntInf | Incumbent    BestBd   Gap | It/Node Time</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;      0     0 3720.04500    0 50171 3732.89000 3720.04500  0.34%     -   52s</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Explored 1 nodes (58105 simplex iterations) in 52.63 seconds (146.73 work units)</span></span>
<span><span class="co">#&gt; Thread count was 9 (of 10 available processors)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Solution count 2: 3732.89 3732.9 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Optimal solution found (tolerance 1.00e-01)</span></span>
<span><span class="co">#&gt; Best objective 3.732890000000e+03, best bound 3.720045002821e+03, gap 0.3441%</span></span>
<span></span>
<span><span class="co"># Convert the prioritization into a more digestible format</span></span>
<span><span class="va">result_sf</span> <span class="op">&lt;-</span> <span class="fu">patchwise</span><span class="fu">::</span><span class="fu"><a href="../reference/convert_solution.html">convert_solution</a></span><span class="op">(</span>solution <span class="op">=</span> <span class="va">solution_sf</span>, patch_df <span class="op">=</span> <span class="va">patches_df_sf</span>, spatial_grid <span class="op">=</span> <span class="va">planning_sf</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Show the results</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">result_sf</span>, main <span class="op">=</span> <span class="cn">NULL</span>, border <span class="op">=</span> <span class="cn">F</span><span class="op">)</span></span></code></pre></div>
<p><img src="locked_in_out_files/figure-html/unnamed-chunk-10-1.png" width="700"></p>
<p>The areas in yellow are those selected by the prioritization for
protection. We can clearly see the locked-in area (the yellow square)
was included!</p>
</div>
<div class="section level2">
<h2 id="implement-locked-out-areas-using-an-sf-input">Implement locked-out areas using an <code>sf</code> input<a class="anchor" aria-label="anchor" href="#implement-locked-out-areas-using-an-sf-input"></a>
</h2>
<p>What if we want to note of an area that we cannot consider for
protection? We can include a “locked-out” area. We repeat the example
above, but this time we will exclude this area from the prioritization
results.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create a fake locked-out area</span></span>
<span><span class="va">no_protection</span> <span class="op">&lt;-</span> <span class="fu">create_area</span><span class="op">(</span><span class="va">planning_sf</span>, <span class="fl">20</span>, <span class="fl">95</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot fake locked-out area</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">no_protection</span>, main <span class="op">=</span> <span class="cn">NULL</span>, border <span class="op">=</span> <span class="cn">F</span><span class="op">)</span></span></code></pre></div>
<p><img src="locked_in_out_files/figure-html/unnamed-chunk-11-1.png" width="700"></p>
<p>Now we can continue using <code>patchwise</code> to group seamount
areas so that entire seamount ranges are protected (and not portions of
seamounts).</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create patches dataframe - this creates several constraints so that entire seamount units are protected together</span></span>
<span><span class="va">patches_df_sf</span> <span class="op">&lt;-</span> <span class="fu">patchwise</span><span class="fu">::</span><span class="fu"><a href="../reference/create_patch_df.html">create_patch_df</a></span><span class="op">(</span>spatial_grid <span class="op">=</span> <span class="va">planning_sf</span>, features <span class="op">=</span> <span class="va">features_sf</span>, patches <span class="op">=</span> <span class="va">patches_sf</span>, costs <span class="op">=</span> <span class="va">cost_sf</span>, locked_out <span class="op">=</span> <span class="va">no_protection</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Processing patch 1 of 7"</span></span>
<span><span class="co">#&gt; [1] "Processing patch 2 of 7"</span></span>
<span><span class="co">#&gt; [1] "Processing patch 3 of 7"</span></span>
<span><span class="co">#&gt; [1] "Processing patch 4 of 7"</span></span>
<span><span class="co">#&gt; [1] "Processing patch 5 of 7"</span></span>
<span><span class="co">#&gt; [1] "Processing patch 6 of 7"</span></span>
<span><span class="co">#&gt; [1] "Processing patch 7 of 7"</span></span>
<span></span>
<span><span class="co"># Create boundary matrix for prioritizr</span></span>
<span><span class="va">boundary_matrix_sf</span> <span class="op">&lt;-</span> <span class="fu">patchwise</span><span class="fu">::</span><span class="fu"><a href="../reference/create_boundary_matrix.html">create_boundary_matrix</a></span><span class="op">(</span>spatial_grid <span class="op">=</span> <span class="va">planning_sf</span>, patches <span class="op">=</span> <span class="va">patches_sf</span>, patch_df <span class="op">=</span> <span class="va">patches_df_sf</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create targets for protection - let's just do 20% for each feature (including 20% of whole seamounts)</span></span>
<span><span class="va">targets_sf</span> <span class="op">&lt;-</span> <span class="fu">patchwise</span><span class="fu">::</span><span class="fu"><a href="../reference/features_targets.html">features_targets</a></span><span class="op">(</span>targets <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0.2</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">features_sf</span><span class="op">)</span><span class="op">)</span>, features <span class="op">=</span> <span class="va">features_sf</span>, pre_patches <span class="op">=</span> <span class="va">seamounts_sf</span>, locked_out <span class="op">=</span> <span class="va">no_protection</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add these targets to targets for protection for the "constraints" we introduced to protect entire seamount units</span></span>
<span><span class="va">constraints_sf</span> <span class="op">&lt;-</span> <span class="fu">patchwise</span><span class="fu">::</span><span class="fu"><a href="../reference/constraints_targets.html">constraints_targets</a></span><span class="op">(</span>feature_targets <span class="op">=</span> <span class="va">targets_sf</span>, patch_df <span class="op">=</span> <span class="va">patches_df_sf</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Run the prioritization</span></span>
<span><span class="va">problem_sf</span> <span class="op">&lt;-</span> <span class="fu">prioritizr</span><span class="fu">::</span><span class="fu"><a href="https://prioritizr.net/reference/problem.html" class="external-link">problem</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">patches_df_sf</span>, features <span class="op">=</span> <span class="va">constraints_sf</span><span class="op">$</span><span class="va">feature</span>, cost_column <span class="op">=</span> <span class="st">"cost"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">prioritizr</span><span class="fu">::</span><span class="fu"><a href="https://prioritizr.net/reference/add_min_set_objective.html" class="external-link">add_min_set_objective</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">prioritizr</span><span class="fu">::</span><span class="fu"><a href="https://prioritizr.net/reference/add_manual_targets.html" class="external-link">add_manual_targets</a></span><span class="op">(</span><span class="va">constraints_sf</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">prioritizr</span><span class="fu">::</span><span class="fu"><a href="https://prioritizr.net/reference/add_binary_decisions.html" class="external-link">add_binary_decisions</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">prioritizr</span><span class="fu">::</span><span class="fu"><a href="https://prioritizr.net/reference/add_boundary_penalties.html" class="external-link">add_boundary_penalties</a></span><span class="op">(</span>penalty <span class="op">=</span> <span class="fl">0.000002</span>, data <span class="op">=</span> <span class="va">boundary_matrix_sf</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">prioritizr</span><span class="fu">::</span><span class="fu"><a href="https://prioritizr.net/reference/add_gurobi_solver.html" class="external-link">add_gurobi_solver</a></span><span class="op">(</span>gap <span class="op">=</span> <span class="fl">0.1</span>, threads <span class="op">=</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html" class="external-link">detectCores</a></span><span class="op">(</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Solve the prioritization</span></span>
<span><span class="va">solution_sf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/solve.html" class="external-link">solve</a></span><span class="op">(</span><span class="va">problem_sf</span><span class="op">)</span></span>
<span><span class="co">#&gt; Gurobi Optimizer version 10.0.0 build v10.0.0rc2 (mac64[arm])</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; CPU model: Apple M1 Max</span></span>
<span><span class="co">#&gt; Thread count: 10 physical cores, 10 logical processors, using up to 9 threads</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Optimize a model with 76981 rows, 56170 columns and 218035 nonzeros</span></span>
<span><span class="co">#&gt; Model fingerprint: 0x908efcd6</span></span>
<span><span class="co">#&gt; Variable types: 0 continuous, 56170 integer (56170 binary)</span></span>
<span><span class="co">#&gt; Coefficient statistics:</span></span>
<span><span class="co">#&gt;   Matrix range     [1e+00, 6e+02]</span></span>
<span><span class="co">#&gt;   Objective range  [2e-02, 6e+02]</span></span>
<span><span class="co">#&gt;   Bounds range     [1e+00, 1e+00]</span></span>
<span><span class="co">#&gt;   RHS range        [1e+00, 4e+03]</span></span>
<span><span class="co">#&gt; Found heuristic solution: objective 3732.8450000</span></span>
<span><span class="co">#&gt; Presolve removed 2781 rows and 1608 columns</span></span>
<span><span class="co">#&gt; Presolve time: 0.66s</span></span>
<span><span class="co">#&gt; Presolved: 74200 rows, 54562 columns, 211019 nonzeros</span></span>
<span><span class="co">#&gt; Variable types: 0 continuous, 54562 integer (54562 binary)</span></span>
<span><span class="co">#&gt; Root relaxation presolved: 74200 rows, 54562 columns, 211019 nonzeros</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Deterministic concurrent LP optimizer: primal and dual simplex</span></span>
<span><span class="co">#&gt; Showing first log only...</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Warning: Markowitz tolerance tightened to 0.5</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Root simplex log...</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Iteration    Objective       Primal Inf.    Dual Inf.      Time</span></span>
<span><span class="co">#&gt;    79746    3.7235523e+03   0.000000e+00   1.061966e+03      5s</span></span>
<span><span class="co">#&gt;    88529    3.7209551e+03   0.000000e+00   3.060026e+03     10s</span></span>
<span><span class="co">#&gt;    92967    3.7199995e+03   0.000000e+00   3.016872e+03     15s</span></span>
<span><span class="co">#&gt;    96763    3.7198853e+03   0.000000e+00   7.867408e+03     20s</span></span>
<span><span class="co">#&gt;   101097    3.7198388e+03   0.000000e+00   3.377333e+04     25s</span></span>
<span><span class="co">#&gt;   104743    3.7198308e+03   0.000000e+00   4.639173e+04     30s</span></span>
<span><span class="co">#&gt; Concurrent spin time: 1.30s</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Solved with dual simplex</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Root simplex log...</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Iteration    Objective       Primal Inf.    Dual Inf.      Time</span></span>
<span><span class="co">#&gt;    41579    3.7198669e+03   0.000000e+00   0.000000e+00     33s</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Root relaxation: objective 3.719867e+03, 41579 iterations, 31.89 seconds (90.95 work units)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     Nodes    |    Current Node    |     Objective Bounds      |     Work</span></span>
<span><span class="co">#&gt;  Expl Unexpl |  Obj  Depth IntInf | Incumbent    BestBd   Gap | It/Node Time</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;      0     0 3719.86693    0 49565 3732.84500 3719.86693  0.35%     -   32s</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Explored 1 nodes (41687 simplex iterations) in 33.00 seconds (92.79 work units)</span></span>
<span><span class="co">#&gt; Thread count was 9 (of 10 available processors)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Solution count 1: 3732.85 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Optimal solution found (tolerance 1.00e-01)</span></span>
<span><span class="co">#&gt; Best objective 3.732845000000e+03, best bound 3.719866927108e+03, gap 0.3477%</span></span>
<span></span>
<span><span class="co"># Convert the prioritization into a more digestible format</span></span>
<span><span class="va">result_sf</span> <span class="op">&lt;-</span> <span class="fu">patchwise</span><span class="fu">::</span><span class="fu"><a href="../reference/convert_solution.html">convert_solution</a></span><span class="op">(</span>solution <span class="op">=</span> <span class="va">solution_sf</span>, patch_df <span class="op">=</span> <span class="va">patches_df_sf</span>, spatial_grid <span class="op">=</span> <span class="va">planning_sf</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Show the results</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">result_sf</span>, main <span class="op">=</span> <span class="cn">NULL</span>, border <span class="op">=</span> <span class="cn">F</span><span class="op">)</span></span></code></pre></div>
<p><img src="locked_in_out_files/figure-html/unnamed-chunk-12-1.png" width="700">
Great! The area that we don’t want to include in the solution is
removed!</p>
</div>
<div class="section level2">
<h2 id="implement-locked-in-and-locked-out-areas-using-an-sf-input">Implement locked-in and locked-out areas using an <code>sf</code>
input<a class="anchor" aria-label="anchor" href="#implement-locked-in-and-locked-out-areas-using-an-sf-input"></a>
</h2>
<p>We can also run a scenario in which we have both locked-in and
locked-out areas.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create patches dataframe - this creates several constraints so that entire seamount units are protected together</span></span>
<span><span class="va">patches_df_sf</span> <span class="op">&lt;-</span> <span class="fu">patchwise</span><span class="fu">::</span><span class="fu"><a href="../reference/create_patch_df.html">create_patch_df</a></span><span class="op">(</span>spatial_grid <span class="op">=</span> <span class="va">planning_sf</span>, features <span class="op">=</span> <span class="va">features_sf</span>, patches <span class="op">=</span> <span class="va">patches_sf</span>, costs <span class="op">=</span> <span class="va">cost_sf</span>, locked_in <span class="op">=</span> <span class="va">mpa_location</span>, locked_out <span class="op">=</span> <span class="va">no_protection</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Processing patch 1 of 7"</span></span>
<span><span class="co">#&gt; [1] "Processing patch 2 of 7"</span></span>
<span><span class="co">#&gt; [1] "Processing patch 3 of 7"</span></span>
<span><span class="co">#&gt; [1] "Processing patch 4 of 7"</span></span>
<span><span class="co">#&gt; [1] "Processing patch 5 of 7"</span></span>
<span><span class="co">#&gt; [1] "Processing patch 6 of 7"</span></span>
<span><span class="co">#&gt; [1] "Processing patch 7 of 7"</span></span>
<span></span>
<span><span class="co"># Create boundary matrix for prioritizr</span></span>
<span><span class="va">boundary_matrix_sf</span> <span class="op">&lt;-</span> <span class="fu">patchwise</span><span class="fu">::</span><span class="fu"><a href="../reference/create_boundary_matrix.html">create_boundary_matrix</a></span><span class="op">(</span>spatial_grid <span class="op">=</span> <span class="va">planning_sf</span>, patches <span class="op">=</span> <span class="va">patches_sf</span>, patch_df <span class="op">=</span> <span class="va">patches_df_sf</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create targets for protection - let's just do 20% for each feature (including 20% of whole seamounts)</span></span>
<span><span class="va">targets_sf</span> <span class="op">&lt;-</span> <span class="fu">patchwise</span><span class="fu">::</span><span class="fu"><a href="../reference/features_targets.html">features_targets</a></span><span class="op">(</span>targets <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0.2</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">features_sf</span><span class="op">)</span><span class="op">)</span>, features <span class="op">=</span> <span class="va">features_sf</span>, pre_patches <span class="op">=</span> <span class="va">seamounts_sf</span>, locked_in <span class="op">=</span> <span class="va">mpa_location</span>, locked_out <span class="op">=</span> <span class="va">no_protection</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add these targets to targets for protection for the "constraints" we introduced to protect entire seamount units</span></span>
<span><span class="va">constraints_sf</span> <span class="op">&lt;-</span> <span class="fu">patchwise</span><span class="fu">::</span><span class="fu"><a href="../reference/constraints_targets.html">constraints_targets</a></span><span class="op">(</span>feature_targets <span class="op">=</span> <span class="va">targets_sf</span>, patch_df <span class="op">=</span> <span class="va">patches_df_sf</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Run the prioritization</span></span>
<span><span class="va">problem_sf</span> <span class="op">&lt;-</span> <span class="fu">prioritizr</span><span class="fu">::</span><span class="fu"><a href="https://prioritizr.net/reference/problem.html" class="external-link">problem</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">patches_df_sf</span>, features <span class="op">=</span> <span class="va">constraints_sf</span><span class="op">$</span><span class="va">feature</span>, cost_column <span class="op">=</span> <span class="st">"cost"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">prioritizr</span><span class="fu">::</span><span class="fu"><a href="https://prioritizr.net/reference/add_min_set_objective.html" class="external-link">add_min_set_objective</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">prioritizr</span><span class="fu">::</span><span class="fu"><a href="https://prioritizr.net/reference/add_manual_targets.html" class="external-link">add_manual_targets</a></span><span class="op">(</span><span class="va">constraints_sf</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">prioritizr</span><span class="fu">::</span><span class="fu"><a href="https://prioritizr.net/reference/add_binary_decisions.html" class="external-link">add_binary_decisions</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">prioritizr</span><span class="fu">::</span><span class="fu"><a href="https://prioritizr.net/reference/add_boundary_penalties.html" class="external-link">add_boundary_penalties</a></span><span class="op">(</span>penalty <span class="op">=</span> <span class="fl">0.000002</span>, data <span class="op">=</span> <span class="va">boundary_matrix_sf</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">prioritizr</span><span class="fu">::</span><span class="fu"><a href="https://prioritizr.net/reference/add_gurobi_solver.html" class="external-link">add_gurobi_solver</a></span><span class="op">(</span>gap <span class="op">=</span> <span class="fl">0.1</span>, threads <span class="op">=</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html" class="external-link">detectCores</a></span><span class="op">(</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Solve the prioritization</span></span>
<span><span class="va">solution_sf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/solve.html" class="external-link">solve</a></span><span class="op">(</span><span class="va">problem_sf</span><span class="op">)</span></span>
<span><span class="co">#&gt; Gurobi Optimizer version 10.0.0 build v10.0.0rc2 (mac64[arm])</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; CPU model: Apple M1 Max</span></span>
<span><span class="co">#&gt; Thread count: 10 physical cores, 10 logical processors, using up to 9 threads</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Optimize a model with 76982 rows, 56170 columns and 218436 nonzeros</span></span>
<span><span class="co">#&gt; Model fingerprint: 0xf4048946</span></span>
<span><span class="co">#&gt; Variable types: 0 continuous, 56170 integer (56170 binary)</span></span>
<span><span class="co">#&gt; Coefficient statistics:</span></span>
<span><span class="co">#&gt;   Matrix range     [1e+00, 6e+02]</span></span>
<span><span class="co">#&gt;   Objective range  [2e-02, 6e+02]</span></span>
<span><span class="co">#&gt;   Bounds range     [1e+00, 1e+00]</span></span>
<span><span class="co">#&gt;   RHS range        [1e+00, 4e+03]</span></span>
<span><span class="co">#&gt; Found heuristic solution: objective 3732.9700000</span></span>
<span><span class="co">#&gt; Presolve removed 4318 rows and 2857 columns</span></span>
<span><span class="co">#&gt; Presolve time: 0.90s</span></span>
<span><span class="co">#&gt; Presolved: 72664 rows, 53313 columns, 206757 nonzeros</span></span>
<span><span class="co">#&gt; Variable types: 0 continuous, 53313 integer (53313 binary)</span></span>
<span><span class="co">#&gt; Found heuristic solution: objective 3732.9650000</span></span>
<span><span class="co">#&gt; Root relaxation presolve removed 334 rows and 0 columns</span></span>
<span><span class="co">#&gt; Root relaxation presolved: 72330 rows, 53313 columns, 205755 nonzeros</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Deterministic concurrent LP optimizer: primal and dual simplex</span></span>
<span><span class="co">#&gt; Showing first log only...</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Warning: Markowitz tolerance tightened to 0.25</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Root simplex log...</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Iteration    Objective       Primal Inf.    Dual Inf.      Time</span></span>
<span><span class="co">#&gt;    72945    3.7242572e+03   0.000000e+00   2.489007e+03      5s</span></span>
<span><span class="co">#&gt;    82477    3.7230293e+03   0.000000e+00   1.361611e+03     10s</span></span>
<span><span class="co">#&gt;    93529    3.7221301e+03   0.000000e+00   7.914218e+02     15s</span></span>
<span><span class="co">#&gt;   103462    3.7213169e+03   0.000000e+00   1.078376e+04     20s</span></span>
<span><span class="co">#&gt;   107862    3.7204430e+03   0.000000e+00   7.707059e+04     25s</span></span>
<span><span class="co">#&gt;   112370    3.7203633e+03   0.000000e+00   3.771695e+03     30s</span></span>
<span><span class="co">#&gt;   118782    3.7201490e+03   0.000000e+00   7.820055e+03     35s</span></span>
<span><span class="co">#&gt;   124364    3.7201149e+03   0.000000e+00   9.206287e+03     40s</span></span>
<span><span class="co">#&gt;   127393    3.7201007e+03   0.000000e+00   1.266398e+04     45s</span></span>
<span><span class="co">#&gt;   129603    3.7200977e+03   0.000000e+00   4.353195e+04     50s</span></span>
<span><span class="co">#&gt; Concurrent spin time: 1.66s</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Solved with dual simplex</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Root simplex log...</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Iteration    Objective       Primal Inf.    Dual Inf.      Time</span></span>
<span><span class="co">#&gt;    60783    3.7201850e+03   0.000000e+00   0.000000e+00     53s</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Root relaxation: objective 3.720185e+03, 60783 iterations, 51.61 seconds (137.67 work units)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     Nodes    |    Current Node    |     Objective Bounds      |     Work</span></span>
<span><span class="co">#&gt;  Expl Unexpl |  Obj  Depth IntInf | Incumbent    BestBd   Gap | It/Node Time</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;      0     0 3720.18505    0 48931 3732.96500 3720.18505  0.34%     -   52s</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Explored 1 nodes (60901 simplex iterations) in 52.92 seconds (139.89 work units)</span></span>
<span><span class="co">#&gt; Thread count was 9 (of 10 available processors)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Solution count 2: 3732.97 3732.97 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Optimal solution found (tolerance 1.00e-01)</span></span>
<span><span class="co">#&gt; Best objective 3.732965000000e+03, best bound 3.720185046242e+03, gap 0.3424%</span></span>
<span></span>
<span><span class="co"># Convert the prioritization into a more digestible format</span></span>
<span><span class="va">result_sf</span> <span class="op">&lt;-</span> <span class="fu">patchwise</span><span class="fu">::</span><span class="fu"><a href="../reference/convert_solution.html">convert_solution</a></span><span class="op">(</span>solution <span class="op">=</span> <span class="va">solution_sf</span>, patch_df <span class="op">=</span> <span class="va">patches_df_sf</span>, spatial_grid <span class="op">=</span> <span class="va">planning_sf</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Show the results</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">result_sf</span>, main <span class="op">=</span> <span class="cn">NULL</span>, border <span class="op">=</span> <span class="cn">F</span><span class="op">)</span></span></code></pre></div>
<p><img src="locked_in_out_files/figure-html/unnamed-chunk-13-1.png" width="700"></p>
<p>It looks like we got the results we wanted - the locked-in areas were
included in the prioritization output as an area to protect, and the
locked-out areas were not included!</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Echelle Burns.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
